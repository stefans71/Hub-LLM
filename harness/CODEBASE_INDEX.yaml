# =============================================================================
# HUB-LLM CODEBASE INDEX
# =============================================================================
# Single source of truth for codebase structure.
# Director reads this INSTEAD of scanning source code.
# Lead Engineer UPDATES this after every task that changes code.
#
# Generated by: DOCS-06 task (initial), then maintained by Lead Engineer
# Last full regeneration: Session 86
# Last partial update: Session 130 (FEAT-42: --primary blue→cyan)
# =============================================================================

meta:
  repo: /root/dev/Hub-LLM
  branch: feature/harness-v2
  stack: "FastAPI (Python) + React (Vite) + SQLite (dev) / Postgres (prod)"
  frontend_port: 5173
  backend_port: 8000
  total_jsx_files: 35
  total_pages: 5
  total_components: 28
  total_contexts: 1
  total_backend_routers: 12
  total_backend_services: 6
  total_localStorage_keys: 19
  total_db_tables: 6
  last_full_index_session: 86
  last_partial_update_session: 98

# ============================================================================
# FRONTEND — Entry Points
# ============================================================================
frontend_entry:
  main.jsx:
    path: frontend/src/main.jsx
    lines: 10
    purpose: "React root renderer — mounts App into DOM with StrictMode"
    last_verified_session: 86

  ErrorBoundary.jsx:
    path: frontend/src/components/ErrorBoundary.jsx
    lines: 56
    purpose: "React Error Boundary class component (BUG-68). Catches uncaught render errors, shows fallback UI with reload button. Wraps entire app in App.jsx."
    imports: [react]
    imported_by: [App.jsx]

  App.jsx:
    path: frontend/src/App.jsx
    lines: 452
    purpose: "Root app — routing, auth redirect, project state, setup flow control. Wrapped in ErrorBoundary (BUG-68). Unauthenticated visitors see LandingPage at / with CTA to /auth. handleProjectCreated accepts options.enhance for AI enhancement redirect. enhanceMode state captured from URL, cleared after first render. Workspace gate allows VPS+Claude Code users without API keys (BUG-44). Dual-path welcome screen: API Key card + VPS Subscription card (BUG-46)."
    key_state:
      - {name: projects, type: "useState([])", drives: "project list across app"}
      - {name: activeProject, type: "useState(null)", drives: "currently selected project"}
      - {name: selectedModel, type: "useState('anthropic/claude-sonnet-4')", drives: "global model fallback"}
      - {name: setupComplete, type: "useState(null)", drives: "setup wizard redirect — null=loading, true=done, false=show wizard"}
      - {name: apiKeys, type: "useState({openrouter,claude,github})", drives: "API key availability"}
      - {name: hasVpsAccess, type: "IIFE", drives: "boolean — any VPS with claudeCodeDetected+lastTestSuccess in localStorage (BUG-44)"}
      - {name: enhanceMode, type: "useState(() => searchParams.get('enhance') === 'true')", drives: "one-shot flag for AI enhance banner in workspace (FEAT-25)"}
    api_calls:
      - {endpoint: "/api/projects/", method: GET, purpose: "load all projects"}
    localStorage_keys:
      - {key: openrouter_key, direction: both}
      - {key: claude_key, direction: both}
      - {key: github_token, direction: both}
    children: [AuthProvider, HeaderNavigation, DashboardSidebar, Workspace, Dashboard, Settings, Setup, CreateProject, AuthPage, AuthCallback, SettingsModal, LandingPage]
    routes:
      - {path: "/", redirect: "/dashboard"}
      - {path: "/auth", component: AuthPage}
      - {path: "/auth/callback", component: AuthCallback}
      - {path: "/setup", component: Setup}
      - {path: "/dashboard", component: Dashboard}
      - {path: "/workspace", component: Workspace}
      - {path: "/settings", component: Settings}
      - {path: "/create-project", component: CreateProject}
    unauthenticated_routes:
      - {path: "/", component: LandingPage, note: "onSignUp navigates to /auth"}
      - {path: "/auth", component: AuthPage}
      - {path: "*", redirect: "/"}
    last_verified_session: 105

# ============================================================================
# FRONTEND — Pages (frontend/src/pages/)
# ============================================================================
frontend_pages:
  Dashboard.jsx:
    path: frontend/src/pages/Dashboard.jsx
    lines: 365
    purpose: "Dashboard with project grid/list view and stats cards"
    props: "{onNavigate, onCreateProject}"
    key_state:
      - {name: projects, type: "useState([])", drives: "project cards"}
      - {name: loading, type: "useState(true)", drives: "loading skeleton"}
      - {name: viewMode, type: "useState('grid')", drives: "grid/list toggle"}
      - {name: stats, type: "useState({...})", drives: "stat cards (projects, tokens, agents)"}
    api_calls:
      - {endpoint: "/api/projects/", method: GET, purpose: "fetch projects with auth"}
      - {endpoint: "/api/stats/dashboard", method: GET, purpose: "fetch dashboard stats"}
    localStorage_keys:
      - {key: openrouter_api_key, direction: read}
    children: [StatCard, ProjectCard]
    last_verified_session: 86

  CreateProject.jsx:
    path: frontend/src/pages/CreateProject.jsx
    lines: 2621
    purpose: "5-step project creation wizard with explicit track selection (BUG-48): Terminal Track (VPS + CLI) vs OpenRouter Track. PRP generation via OpenRouter chat (FEAT-32). Syncs VPS server to backend before project creation to prevent FK violation (BUG-47). GitHub card reframed as optional version control (FEAT-39), VPS card shown first. GitHub OAuth pre-check with graceful error (BUG-54). VibeShip CTA button next to PRP download (FEAT-40)."
    props: "{onCancel, onCreateProject}"
    imports: [ModelSelector]
    key_state:
      - {name: step, type: useState, drives: "wizard step (0-4)"}
      - {name: formData, type: useState, drives: "project metadata"}
      - {name: selectedModel, type: "useState('anthropic/claude-sonnet-4')", drives: "AI model ID for brief expansion (OpenRouter format, only used when no Claude Code)"}
      - {name: selectedModelMeta, type: "useState(null)", drives: "full model object from ModelSelector onChange"}
      - {name: claudeCodeServer, type: useMemo, drives: "first VPS with Claude Code detected from savedVpsServers"}
      - {name: hasClaudeCode, type: derived, drives: "boolean — whether any VPS has Claude Code"}
      - {name: selectedAgents, type: "useState([])", drives: "agent selection"}
      - {name: selectedMCPServers, type: "useState([])", drives: "MCP server selection"}
      - {name: selectedTrack, type: "useState(null)", drives: "track selection: 'terminal' | 'openrouter', defaulted by hasClaudeCode useEffect (BUG-48)"}
    api_calls:
      - {endpoint: "/api/projects/", method: POST, purpose: "create project"}
      - {endpoint: "/api/ssh/test", method: POST, purpose: "test VPS connection"}
      - {endpoint: "/api/ai/expand-brief", method: POST, purpose: "AI brief expansion (OpenRouter only)"}
      - {endpoint: "/api/ai/chat", method: POST, purpose: "AI planning chat (OpenRouter only)"}
    localStorage_keys:
      - {key: vps_servers, direction: both}
      - {key: global_agents, direction: read}
      - {key: mcp_servers, direction: read}
      - {key: openrouter_key, direction: read}
      - {key: openrouter_api_key, direction: read}
    last_verified_session: 113

  ExportModal.jsx:
    path: frontend/src/components/ExportModal.jsx
    lines: 207
    purpose: "FEAT-51: Confirmation modal for project export. Shows included/excluded files list, handles tar.gz download with spinner, error handling."
    props: "{project, open, onClose}"
    key_state:
      - {name: downloading, type: useState, drives: "download in progress spinner"}
    api_calls:
      - {endpoint: "/api/projects/{id}/export", method: GET, purpose: "download project tar.gz"}
    last_verified_session: 138

  Setup.jsx:
    path: frontend/src/pages/Setup.jsx
    lines: 1301
    purpose: "Post-signup wizard — choose OpenRouter API key OR VPS+Anthropic Pro path"
    props: "{onComplete}"
    key_state:
      - {name: step, type: "useState(0)", drives: "wizard step"}
      - {name: path, type: "useState(null)", drives: "'openrouter' or 'anthropic'"}
      - {name: completing, type: useState, drives: "completion spinner"}
      - {name: skipError, type: "useState(null)", drives: "inline error when skip API fails"}
    sub_components: [ChoosePathStep, WaitlistCard, OpenRouterStep, SSHHelpModal, AnthropicStep]
    icon_usage:
      - {component: PathCard, line: 78, renders: "lucide icon OR img tag (objectFit:contain) based on typeof icon prop, iconSize prop (default 24)"}
      - {component: ChoosePathStep, line: 163, icon: "openrouter-logo.svg (was lucide Key)"}
      - {component: ChoosePathStep, line: 170, icon: "claude-code-logo.svg (was lucide Sparkles)"}
      - {component: SSHHelpModal, line: 462, icon: "X (lucide) — close button"}
      - {component: AnthropicStep, line: 737, icon: "HelpCircle (lucide) — SSH help button"}
      - {component: AnthropicStep, line: 989, icon: "Sparkles (lucide) — Claude Code detection indicator"}
    ui_features:
      - {component: SSHHelpModal, line: 462, desc: "Fixed overlay modal with backdrop, 4-section SSH key guide (generate, add to VPS, find key, copy to Hub-LLM). Responsive: full-width on mobile <600px via maxWidth+padding."}
      - {component: AnthropicStep, line: 737, desc: "Help button with HelpCircle icon below subtitle, hover highlights blue, opens SSHHelpModal"}
    api_calls:
      - {endpoint: "https://openrouter.ai/api/v1/models", method: GET, purpose: "validate OpenRouter key"}
      - {endpoint: "/api/ssh/test", method: POST, purpose: "test VPS connection"}
      - {endpoint: "/api/auth/me/setup-complete", method: POST, purpose: "mark setup done"}
      - {endpoint: "/api/waitlist/", method: POST, purpose: "join VibeShip.cloud beta waitlist"}
    localStorage_keys:
      - {key: openrouter_key, direction: both}
      - {key: vps_servers, direction: both}
    last_verified_session: 93

  Settings.jsx:
    path: frontend/src/pages/Settings.jsx
    lines: 4888
    purpose: "Comprehensive settings — profile, API keys, models, VPS (with idle timeout toggle), agents, skills, MCP, appearance"
    props: "{onBack, onLogout}"
    sub_components:
      - ProfileSettings
      - DefaultModelSettings
      - VoiceSettings
      - APIKeysSettings
      - AppearanceSettings
      - GlobalMCPSettings (+ MCPModal)
      - GlobalAgentsSettings (+ AgentModal)
      - GlobalSkillsSettings (+ SkillModal)
      - VPSConnectionsSettings (+ VPSModal)
    localStorage_keys:
      - {key: ai_assistant_alias, direction: both}
      - {key: user_timezone, direction: both}
      - {key: default_model, direction: both}
      - {key: voice_input_enabled, direction: both}
      - {key: openrouter_api_key, direction: both}
      - {key: openrouter_key, direction: both}
      - {key: theme, direction: both}
      - {key: compact_mode, direction: both}
      - {key: show_line_numbers, direction: both}
      - {key: mcp_servers, direction: both}
      - {key: global_agents, direction: both}
      - {key: global_skills, direction: both}
      - {key: vps_servers, direction: both}
    api_calls:
      - {endpoint: "/api/settings/", method: GET, purpose: "load user settings"}
      - {endpoint: "/api/ssh/servers", method: "GET/POST/DELETE", purpose: "VPS CRUD + backend sync"}
    last_verified_session: 86

  LandingPage.jsx:
    path: frontend/src/pages/LandingPage.jsx
    lines: 953
    purpose: "Interactive HTML prototype landing page converted to React — full demo with model selector (Claude Code SVG logo), chat, file explorer, terminal, VPS cards, and inline auth panel"
    props: "{onSignUp} — DEPRECATED callback, now uses inline auth panel instead"
    key_state:
      - {name: selectedModel, type: "useState(DEMO_MODELS[0])", drives: "currently selected model from 9-model dropdown"}
      - {name: isModelDropdownOpen, type: "useState(false)", drives: "model dropdown visibility"}
      - {name: modelSearchQuery, type: "useState('')", drives: "model search filter"}
      - {name: currentProject, type: "useState(1)", drives: "active demo project (1-3) — controls VPS cables, file tree, terminal path"}
      - {name: messages, type: "useState(INITIAL_MESSAGES)", drives: "chat message history"}
      - {name: isTyping, type: "useState(false)", drives: "AI typing indicator"}
      - {name: isFileExplorerOpen, type: "useState(false)", drives: "file explorer panel collapse"}
      - {name: isTerminalOpen, type: "useState(false)", drives: "terminal panel collapse"}
      - {name: isVPSOpen, type: "useState(true)", drives: "VPS section collapse"}
      - {name: activePanelId, type: "useState(null)", drives: "about/pricing/auth panel toggle"}
      - {name: terminalLines, type: "useState([])", drives: "terminal output lines"}
      - {name: expandedFolders, type: "useState({})", drives: "file tree folder expansion state"}
      - {name: selectedFile, type: "useState(null)", drives: "highlighted file in tree"}
      - {name: chatInput, type: "useState('')", drives: "chat input field"}
      - {name: terminalInput, type: "useState('')", drives: "terminal input field"}
      - {name: isCursorVisible, type: "useState(true)", drives: "terminal cursor blink"}
      - {name: authTab, type: "useState('signup')", drives: "auth panel tab (signup/login)", line: 219}
      - {name: formData, type: "useState({name,email,password})", drives: "auth form fields", line: 220}
      - {name: authError, type: "useState('')", drives: "auth error message", line: 225}
      - {name: authLoading, type: "useState(false)", drives: "auth submit loading state", line: 226}
      - {name: oauthProviders, type: "useState({github,google})", drives: "available OAuth providers", line: 227}
    static_data:
      - "DEMO_MODELS — 9 models (Claude, GPT, Gemini, Llama, DeepSeek, Mistral) with provider colors"
      - "DEMO_PROJECTS — 3 projects (Landing Page, API Server, Mobile App) with VPS names + file trees"
      - "VPS_CARDS — 3 VPS cards (DigitalOcean, Vultr, Vercel) with names/IPs"
      - "INITIAL_MESSAGES — 3 demo chat messages"
      - "passwordRules — 3 validation rules (min 8 chars, uppercase, number+special)"
    features:
      - "Model selector dropdown with search/filter"
      - "Fake AI chat with typing indicator, auto-scroll, message bubbles"
      - "File explorer with project switcher, VS Code-style tree, folder expand/collapse"
      - "Fake terminal with working ls/pwd/cd/clear commands"
      - "VPS cards with animated cable connections (SVG paths) — cable highlights for active project"
      - "About/Pricing/Auth info panels (collapsible)"
      - "Inline auth panel with signup/login tabs, OAuth (GitHub/Google), password validation"
      - "Sticky header with logo, pipeline, nav menu"
      - "Floating particle animation background"
      - "Traveling light animation on hub-box border — fades out when any panel opens (panel-open class)"
      - "Spotlight glow ::before pseudo-element on info-panel.open — cyan gradient shining downward, stronger on auth-panel"
    auth_integration:
      - {hook: useAuth, line: 2, purpose: "access signup/login/handleOAuthCallback"}
      - {fetch_oauth_providers: "/api/auth/oauth/providers", line: 267}
      - {auth_panel_trigger: "togglePanel('auth')", callers: "Sign Up nav button, 3 pricing buttons"}
    useEffect_cleanup:
      - "Particles DOM nodes cleanup on unmount"
      - "Traveling light requestAnimationFrame cancelAnimationFrame cleanup"
      - "Outside click handler cleanup for model dropdown"
    api_calls:
      - {endpoint: "/api/auth/oauth/providers", method: GET, purpose: "fetch OAuth providers", line: 268}
    localStorage_keys: []
    children: []
    imported_by: [App.jsx]
    last_verified_session: 98

  LandingPage.css:
    path: frontend/src/pages/LandingPage.css
    lines: 1636
    purpose: "Scoped CSS for LandingPage component — all selectors prefixed with .landing-page to avoid global conflicts. Spotlight glow (UI-12), cyan auth+send buttons, white Sign Up nav, 26px model icon, AI=orange/user=cyan bubbles (UI-15), 0.98rem footer"
    animations:
      - {name: lp-float, purpose: "particle floating from bottom to top"}
      - {name: lp-pulse, purpose: "status dot pulsing"}
      - {name: lp-fadeIn, purpose: "chat message fade-in"}
      - {name: lp-typingBounce, purpose: "typing indicator bounce"}
      - {name: lp-blink, purpose: "terminal cursor blink"}
      - {name: lp-flow, purpose: "cable data flow animation (stroke-dashoffset)"}
    color_palette:
      - {color: "#38bdf8", usage: "sky blue primary — model dropdown, borders, accents"}
      - {color: "#f97316", usage: "orange accent — CTA buttons, active cables, Pro tier"}
      - {color: "#22c55e", usage: "green success — status indicators, terminal prompt"}
      - {note: "Intentionally different from app palette — landing page is marketing, not app UI"}
    design_patterns:
      - "Grid background via ::before pseudo-element with fixed positioning"
      - "Renamed .hidden → .lp-hidden to avoid Tailwind conflict"
      - "Gradient backgrounds for hub-box, VPS cards, pricing featured card"
      - "Traveling light glow effect via multiple box-shadows"
      - "Cable SVG paths with stroke-dasharray animation for data flow"
      - "Max-height transitions for collapsible panels (info, pricing, auth, file explorer, terminal, VPS)"
    auth_panel_styles:
      - {class: ".auth-panel.open", max_height: "550px", line: 666}
      - {class: ".auth-tabs", purpose: "tab navigation container", line: 674}
      - {class: ".auth-tab", purpose: "individual tab button", line: 682}
      - {class: ".auth-error", purpose: "error message styling", line: 706}
      - {class: ".auth-form", purpose: "form container", line: 716}
      - {class: ".auth-input-group", purpose: "input field wrapper", line: 722}
      - {class: ".auth-input", purpose: "styled input field", line: 729}
      - {class: ".auth-password-wrapper", purpose: "password field container", line: 753}
      - {class: ".auth-password-toggle", purpose: "show/hide password button", line: 761}
      - {class: ".auth-requirements", purpose: "password requirements list", line: 783}
      - {class: ".auth-req-item", purpose: "requirement item with check/x icon", line: 791}
      - {class: ".auth-submit-btn", purpose: "submit button", line: 814}
      - {class: ".auth-divider", purpose: "OR divider with line", line: 825}
      - {class: ".auth-oauth-buttons", purpose: "OAuth button container", line: 842}
      - {class: ".auth-oauth-btn", purpose: "GitHub/Google OAuth buttons", line: 848}
      - {class: ".auth-terms", purpose: "terms/privacy links", line: 870}
    responsive:
      - "@media (max-width: 768px) — stacks pricing cards, hides header features, single-column VPS grid, adjusts chat header layout"
    last_verified_session: 98

# ============================================================================
# FRONTEND — Static Files (frontend/public/)
# ============================================================================
frontend_static:
  docs_portal:
    path: frontend/public/docs/
    purpose: "Multi-page static HTML docs portal (FEAT-41). HubLLM platform help — dark theme, shared nav sidebar, text search, HubLLM+VibeShip branding."
    served_at: "/docs/"
    loaded_by: [Workspace.jsx]
    files:
      - {name: index.html, purpose: "Hub/landing page — card grid linking to all doc pages, search bar, what's-new preview"}
      - {name: welcome.html, purpose: "Getting started guide (migrated from welcome-to-hubllm.html) — first steps, workspace diagram, quick tips"}
      - {name: workspace-guide.html, purpose: "Detailed walkthrough of every workspace panel — top bar, file explorer, terminal chat, preview, LLM-Dev"}
      - {name: git-github.html, purpose: "Git/GitHub setup — what is git, commits, GitHub account creation, push/pull commands, branching"}
      - {name: whats-new.html, purpose: "Changelog — feature/fix/improvement entries with dates and tags"}
      - {name: harness-guide.html, purpose: "Harness system explained — CODEBASE_INDEX, feature_queue, learnings, CLAUDE.md, Director/Engineer workflow, pre-commit hook"}
      - {name: nav.js, purpose: "Shared vanilla JS — injects sidebar nav with Feather SVG icons (FEAT-44), current-page highlighting, text search with mark highlighting"}
      - {name: styles.css, purpose: "Shared dark theme stylesheet — SVG nav-icon layout, two-line footer (footer-brand 16px + footer-tagline 12px), responsive at 600px/420px breakpoints"}

# ============================================================================
# FRONTEND — Styles (frontend/src/)
# ============================================================================
frontend_styles:
  index.css:
    path: frontend/src/index.css
    lines: 1339
    purpose: "Global CSS — Tailwind imports, :root theme variables (FEAT-42: --primary #38bdf8 cyan, --primary-hover #0ea5e9, --accent #f97316, --success #22c55e, --error #ef4444), component styles for auth, setup, dashboard, workspace, settings, modals, animations"

# ============================================================================
# FRONTEND — Components (frontend/src/components/)
# ============================================================================
frontend_components:
  Workspace.jsx:
    path: frontend/src/components/Workspace.jsx
    lines: 642
    purpose: "Main workspace orchestrator — SSH auto-connect, model persistence, panel layout with draggable preview divider (FEAT-38), auto-load docs portal on first project visit via localStorage (FEAT-37/41), preview always open by default (BUG-62), Claude processing state, enhance banner threading, export modal (FEAT-51), memoized handleSshReconnected (BUG-68)"
    props: "{project, model, apiKeys, onProjectChange, enhanceWithAI}"
    key_state:
      - {name: isConnected, type: useState, drives: "SSH connection status"}
      - {name: isConnecting, type: useState, drives: "connecting spinner"}
      - {name: claudeCodeStatus, type: "useState({installed:false,authenticated:false})", drives: "Claude Code detection"}
      - {name: selectedModel, type: useState, drives: "per-project model"}
      - {name: linkedServerId, type: useState, drives: "VPS server for this project"}
      - {name: editorApiRef, type: useRef, drives: "LLMDevPanel editor API"}
      - {name: fileExplorerOpen, type: useState, drives: "left sidebar toggle"}
      - {name: activeSidebarPanel, type: useState, drives: "icon sidebar selection"}
    api_calls:
      - {endpoint: "/api/ssh/servers", method: GET, purpose: "check connection status"}
      - {endpoint: "/api/ssh/servers", method: POST, purpose: "sync server to backend"}
      - {endpoint: "/api/ssh/servers/{id}/connect", method: POST, purpose: "establish SSH"}
      - {endpoint: "/api/projects/{id}", method: PATCH, purpose: "save selected model"}
    localStorage_keys:
      - {key: vps_servers, direction: read}
      - {key: last_used_model, direction: both}
    children: [Chat, WorkspaceTopBar, WorkspaceIconSidebar, WorkspaceFileExplorer, LLMDevPanel, PreviewPanel, ExportModal]
    known_issues:
      - {desc: "linkedServerId not updating on project change", sessions: [73], status: fixed}
    last_verified_session: 105

  Chat.jsx:
    path: frontend/src/components/Chat.jsx
    lines: 566
    purpose: "Chat panel — routes to OpenRouter chat or ClaudeCodeTerminalChat based on model+VPS. BUG-69: all hooks above early return for stable hook count."
    props: "{project, model, apiKeys, serverId, claudeCodeStatus, onProcessingChange, enhanceWithAI}"
    key_state:
      - {name: messages, type: "useState([])", drives: "chat history"}
      - {name: input, type: useState, drives: "user input"}
      - {name: isLoading, type: useState, drives: "loading indicator"}
      - {name: attachedImages, type: "useState([])", drives: "FIFO image queue (max 4)"}
      - {name: isDragging, type: useState, drives: "drag overlay"}
      - {name: dragCounterRef, type: useRef, drives: "nested drag enter/leave tracking"}
    routing_logic: "useClaudeCodeTerminal = isAnthropicModel && claudeCodeStatus?.authenticated && serverId"
    children: [ClaudeCodeTerminalChat, VoiceInput]
    known_issues:
      - {desc: "claudeCodeStatus timing — shows welcome before check", sessions: [81, 82], status: fixed}
    last_verified_session: 105

  ClaudeCodeTerminalChat.jsx:
    path: frontend/src/components/ClaudeCodeTerminalChat.jsx
    lines: 1151
    purpose: "Terminal-based Claude Code chat with bubble/terminal view toggle, per-project session tracking, enhance banner with copy-to-clipboard, collapsible hint card pointing to Welcome guide in Preview panel (FEAT-35/FEAT-37), auto-cd to project dir on connect (FEAT-33)"
    props: "{project, serverId, projectSlug, onProcessingChange, enhanceWithAI, autoStart}"
    key_state:
      - {name: messages, type: "useState([])", drives: "parsed chat bubbles"}
      - {name: viewMode, type: useState, drives: "'terminal' or 'bubbles'"}
      - {name: isProcessing, type: useState, drives: "thinking indicator"}
      - {name: processingText, type: useState, drives: "spinner word display"}
      - {name: waitingForEchoRef, type: useRef, drives: "echo detection skip"}
      - {name: outputBufferRef, type: useRef, drives: "accumulated terminal output"}
      - {name: showEnhanceBanner, type: "useState(!!enhanceWithAI)", drives: "orange banner visibility (FEAT-25)"}
      - {name: copied, type: "useState(false)", drives: "2s 'Copied!' feedback on clipboard button"}
    features:
      - "xterm.js terminal with WebSocket to VPS"
      - "Auto-runs 'claude' command on connect"
      - "Bubble view with ANSI stripping and markdown"
      - "Echo detection to skip user input in Claude output"
      - "Spinner word filtering (50+ words)"
      - "Processing indicator with bouncing dots"
      - "Enhance banner — shows project brief with copy-to-clipboard button when enhanceWithAI prop is true (FEAT-25)"
    websocket: "/api/terminal/ws?serverId={serverId}"
    last_verified_session: 105

  WorkspaceFileExplorer.jsx:
    path: frontend/src/components/WorkspaceFileExplorer.jsx
    lines: 1082
    purpose: "Left sidebar — project tree with VPS file browsing, status dots, reconnect, processing pulse. Re-fetches projects when currentProject changes (BUG-51)."
    props: "{isOpen, onToggle, currentProject, onSelectProject, onFileSelect, isClaudeProcessing, onSshReconnected}"
    key_state:
      - {name: projects, type: "useState([])", drives: "project list"}
      - {name: expandedProjects, type: useState, drives: "project expansion state"}
      - {name: projectFileTrees, type: useState, drives: "VPS file trees per project"}
      - {name: serverStatuses, type: useState, drives: "connection status per server"}
      - {name: reconnectingServers, type: "useState(Set)", drives: "in-progress reconnections"}
      - {name: deleteModal, type: useState, drives: "delete confirmation"}
    api_calls:
      - {endpoint: "/api/projects/", method: GET, purpose: "fetch projects"}
      - {endpoint: "/api/ssh/servers", method: GET, purpose: "poll statuses every 10s"}
      - {endpoint: "/api/ssh/servers/{id}/connect", method: POST, purpose: "reconnect VPS"}
      - {endpoint: "/api/files", method: GET, purpose: "fetch VPS file tree"}
      - {endpoint: "/api/projects/{id}", method: DELETE, purpose: "delete project"}
    features:
      - "Workspace folder grouping (default, archives)"
      - "Status dots: green=connected, gray=disconnected, red=error"
      - "Click dot to reconnect (INFRA-02)"
      - "Expandable project file trees from VPS"
      - "3-dot context menu (rename, settings, delete)"
      - "Delete modal with archive/permanent options"
    last_verified_session: 86

  ModelSelector.jsx:
    path: frontend/src/components/ModelSelector.jsx
    lines: 805
    purpose: "Reusable model selector dropdown — fetches OpenRouter models, billing mode toggle, search/filter, version-descending sort"
    props: "{value, onChange, apiKeys, claudeCodeStatus, isConnected, showSubscriptionModels, compact, className, style}"
    exports: "default ModelSelector, SUBSCRIPTION_MODELS, getProviderName, getProviderColor, getModelDisplay"
    key_state:
      - {name: dropdownOpen, type: useState, drives: "dropdown open/close"}
      - {name: searchFilter, type: useState, drives: "model search filtering"}
      - {name: openRouterModels, type: useState, drives: "dynamic model list from OpenRouter API"}
      - {name: modelsLoading, type: useState, drives: "loading indicator during fetch"}
      - {name: activeBillingMode, type: "useState('auto')", drives: "billing tab filter: auto|subscription|openrouter"}
      - {name: modelList, type: useMemo, drives: "merged subscription + OpenRouter models"}
      - {name: selectedModel, type: useMemo, drives: "display info for current value"}
    constants:
      - "SUBSCRIPTION_MODELS — hardcoded Anthropic models (tier: subscription, route via Claude Code)"
      - "POPULAR_MODEL_IDS — Set of ~16 curated flagship model IDs (updated Feb 2026)"
      - "PROVIDER_COLORS/PROVIDER_NAMES — color and display name maps for 10 providers"
    features:
      - "Billing mode toggle pills (Pro Subscription / OpenRouter) with green/grey availability dots"
      - "Not-set-up banners when billing tab selected but credentials missing"
      - "onChange includes tier in model object for routing decisions"
      - "Version-descending sort within provider groups (newest models first)"
      - "Popular models shown by default, full list on search"
      - "24h localStorage cache for OpenRouter model list"
      - "Manual refresh button in footer"
      - "Compact mode for smaller trigger button"
      - "showSubscriptionModels prop controls billing toggle visibility"
    api_calls:
      - {endpoint: "https://openrouter.ai/api/v1/models", method: GET, purpose: "fetch dynamic model list, cached 24h in localStorage"}
    localStorage_keys:
      - {key: openrouter_models, direction: both, purpose: "cached OpenRouter model list (JSON)"}
      - {key: openrouter_models_fetched, direction: both, purpose: "cache timestamp for 24h TTL"}
    used_by: [WorkspaceTopBar.jsx, CreateProject.jsx]
    extracted_from: "WorkspaceTopBar.jsx (FEAT-21)"
    last_verified_session: 101

  WorkspaceTopBar.jsx:
    path: frontend/src/components/WorkspaceTopBar.jsx
    lines: 329
    purpose: "Top bar — project name, collapse toggle, model selector OR Claude Code PRO badge (FEAT-29), export button, billing warnings. When isConnected && claudeCodeStatus.installed → static badge, else → ModelSelector dropdown. Detection retries 3x on failure (BUG-63)."
    props: "{project, model, onModelChange, onExport, linkedServerId, isConnected, onClaudeCodeStatusChange, retryTrigger}"
    key_state:
      - {name: showBillingWarning, type: useState, drives: "billing switch modal"}
      - {name: selectedModelValue, type: useState, drives: "current model ID for ModelSelector value"}
      - {name: apiKeys, type: useState, drives: "API key availability for billing logic"}
      - {name: claudeCodeStatus, type: useState, drives: "Claude Code detection status"}
    api_calls:
      - {endpoint: "/api/ssh/servers/{id}/claude-code", method: GET, purpose: "detect Claude Code on VPS"}
    localStorage_keys:
      - {key: openrouter_api_key, direction: read}
      - {key: openrouter_key, direction: read}
      - {key: hide_billing_switch_warning, direction: both}
    children: [ModelSelector, ModelNotification]
    notes: "FEAT-29: When VPS connected with Claude Code, shows static 'Claude Code PRO' badge instead of ModelSelector. ModelSelector only renders for OpenRouter projects."
    last_verified_session: 115

  LLMDevPanel.jsx:
    path: frontend/src/components/LLMDevPanel.jsx
    lines: 601
    purpose: "Bottom collapsible panel — Terminal, Editor (Monaco via CodeEditor), Docker, Logs, Project Context tabs. FEAT-50: Docker/Logs/Context tabs show Coming Soon placeholders (Docker has swimming whale animation). Tab buttons refactored to .map() loop with angled cyan-border styling."
    props: "{project, linkedServerId, onEditorReady, onTerminalConnected}"
    key_state:
      - {name: activeTab, type: "useState('terminal')", drives: "tab selection"}
      - {name: isExpanded, type: useState, drives: "panel collapse/expand"}
      - {name: panelHeight, type: useState, drives: "drag-resizable height"}
      - {name: openEditors, type: "useState([])", drives: "open file tabs in editor"}
    features:
      - "Drag-resizable panel height"
      - "CSS hiding (not conditional render) to preserve WebSocket connections"
      - "Editor API callback pattern for parent integration"
      - "FEAT-50: Angled tabs with cyan border, perspective transform, Coming Soon placeholders"
    children: [MultiTerminal, CodeEditor]
    localStorage_keys:
      - {key: vps_servers, direction: read}
    known_issues:
      - {desc: "Conditional render killed WebSocket connections", sessions: [65], status: fixed}
      - {desc: "Stale closure in openEditors", sessions: [63], status: fixed}
    last_verified_session: 136

  MultiTerminal.jsx:
    path: frontend/src/components/MultiTerminal.jsx
    lines: 1082
    purpose: "Split-pane terminal manager — up to 6 independent terminals (no auto-cd) with 7 bold color palette (FEAT-48) and drag resize. FEAT-49: per-terminal cwd display in status bar. BUG-72: close button in desktop tab header, color picker clamped to viewport. BUG-73: terminals persist across project switches — each terminal owns its serverId/projectId."
    props: "{projectId, serverId, projectSlug, onTerminalConnected}"
    key_state:
      - {name: terminals, type: "useState([])", drives: "terminal instances array — each entry has serverId, projectId"}
      - {name: activeTerminalId, type: useState, drives: "focused terminal"}
      - {name: colorPickerTerminalId, type: useState, drives: "color picker popup"}
      - {name: draggingDividerId, type: useState, drives: "divider drag state"}
      - {name: prevServerIdRef, type: useRef, drives: "BUG-73: detect project switches"}
      - {name: prevProjectIdRef, type: useRef, drives: "BUG-73: detect project switches"}
    sub_component: "TerminalInstance (inline)"
    sub_component_state:
      - {name: cwd, type: useState, drives: "current working directory from connected message"}
    features:
      - "Side-by-side split panes with draggable dividers"
      - "8 color options per terminal (right-click color picker)"
      - "Tab header with colored dots and active underline"
      - "Max 6 terminals"
      - "Delta-based drag resize (BUG-16 fix)"
      - "FEAT-49: Per-terminal cwd display with IP+path tooltip"
      - "BUG-73: Project switch creates new tab instead of reconnecting all. Old terminals stay alive. Dedup by serverId+projectId for auto-created tabs; + button always creates new."
    known_issues:
      - {desc: "fitAddon calculates absurd width without minWidth:0", sessions: [62], status: fixed}
      - {desc: "Divider drag couldn't shrink panes", sessions: [65], status: fixed}
      - {desc: "Project switch killed all terminal sessions", sessions: [], status: "fixed (BUG-73)"}
    last_verified_session: 136

  Terminal.jsx:
    path: frontend/src/components/Terminal.jsx
    lines: 200
    purpose: "Single legacy terminal with xterm.js and WebSocket"
    props: "{serverId, serverName, onClose}"
    websocket: "/api/ssh/servers/{serverId}/terminal"
    last_verified_session: 86

  WorkspaceTerminal.jsx:
    path: frontend/src/components/WorkspaceTerminal.jsx
    lines: 349
    purpose: "Terminal wrapper for workspace with auto-cd to project directory"
    props: "{projectId, serverId, projectSlug, className}"
    features:
      - "Auto-sends cd /root/llm-hub-projects/{slug} on connect"
      - "xterm.js with FitAddon"
      - "requestAnimationFrame + delayed fit for timing"
    last_verified_session: 86

  CodeEditor.jsx:
    path: frontend/src/components/CodeEditor.jsx
    lines: 266
    purpose: "Monaco editor loaded from CDN — 30+ language support, Ctrl+S save. FEAT-52: Markdown preview toggle (ReactMarkdown) with Ctrl+Shift+V shortcut."
    props: "{path, content, onSave, onClose, readOnly}"
    features:
      - "CDN-loaded Monaco (not bundled)"
      - "Language detection from file extension"
      - "Change tracking indicator"
      - "vs-dark theme, word wrap, no minimap"
    last_verified_session: 86

  FileBrowser.jsx:
    path: frontend/src/components/FileBrowser.jsx
    lines: 313
    purpose: "SFTP file browser with inline editing and directory navigation"
    props: "{serverId, serverName}"
    api_calls:
      - {endpoint: "/api/files", method: GET, purpose: "list directory"}
      - {endpoint: "/api/files/content", method: GET, purpose: "read file"}
      - {endpoint: "/api/files/content", method: PUT, purpose: "save file"}
      - {endpoint: "/api/files", method: DELETE, purpose: "delete file/dir"}
    last_verified_session: 86

  PreviewPanel.jsx:
    path: frontend/src/components/PreviewPanel.jsx
    lines: 407
    purpose: "Live preview iframe with editable URL bar, device viewport modes, parent-controlled width/collapse (FEAT-38), onUrlChange callback for welcome persistence (BUG-55), drag overlay (BUG-60)"
    props: "{previewUrl, collapsed, onCollapsedChange, width, onUrlChange, dragging}"
    features:
      - "Device modes: phone (375px), tablet (768px), desktop (1280px), fit — work for BOTH docs and external URLs (BUG-67)"
      - "Editable URL bar with Enter-to-navigate, auto-prepends https://, cyan focus border (FEAT-45)"
      - "Refresh, 'Open in Browser' button, 'Docs' button to return to /docs/index.html (BUG-61)"
      - "onUrlChange callback fires on navigate — parent uses for welcome flag persistence"
      - "isFullBleed = internal docs + Fit mode only → edge-to-edge. All other combos get centered frame with shadow (BUG-67)"
      - "Transparent drag overlay prevents iframe from stealing mouse events during resize (BUG-60)"
      - "DemoPreview removed — defaults to /docs/index.html (BUG-61)"
    last_verified_session: 137

  DashboardSidebar.jsx:
    path: frontend/src/components/DashboardSidebar.jsx
    lines: 358
    purpose: "Dashboard left sidebar — workspace folders, project list, status dots"
    props: "{projects, activeProject, onSelectProject, onNavigate, onCreateProject, currentView, onLogout}"
    features:
      - "Workspace folder grouping"
      - "Clickable status dots with reconnect"
      - "Server status polling"
    last_verified_session: 86

  HeaderNavigation.jsx:
    path: frontend/src/components/HeaderNavigation.jsx
    lines: 153
    purpose: "Top nav bar — Dashboard/Workspace/Settings tabs, user menu. Logo 22px three-part color split (no H box), compact tabs px-3 py-1 (FEAT-43/45)"
    props: "{onLogout}"
    last_verified_session: 133

  AuthPage.jsx:
    path: frontend/src/components/AuthPage.jsx
    lines: 331
    purpose: "Combined login/signup form with OAuth and password validation"
    api_calls:
      - {endpoint: "/api/auth/oauth/providers", method: GET, purpose: "list OAuth providers"}
    sub_components: [PasswordRequirements]
    last_verified_session: 86

  AuthCallback.jsx:
    path: frontend/src/components/AuthCallback.jsx
    lines: 106
    purpose: "OAuth callback handler — extracts tokens from URL, auto-redirects"
    props: "{onComplete}"
    last_verified_session: 86

  ServerManager.jsx:
    path: frontend/src/components/ServerManager.jsx
    lines: 347
    purpose: "Server list management with VPS link/unlink UI"
    localStorage_keys:
      - {key: vps_servers, direction: read}
    last_verified_session: 86

  ServerConnect.jsx:
    path: frontend/src/components/ServerConnect.jsx
    lines: 227
    purpose: "SSH connection dialog — password or key auth, saved servers quick-connect"
    props: "{onConnect, onClose, savedServers}"
    api_calls:
      - {endpoint: "/api/ssh/connect", method: POST, purpose: "test SSH connection"}
    last_verified_session: 86

  # ModelSelector.jsx — DELETED in MODEL-04 (was unused, not imported anywhere)

  ModelNotification.jsx:
    path: frontend/src/components/ModelNotification.jsx
    lines: 122
    purpose: "Modal for provider switch warning with 'Don't show again' checkbox"
    props: "{isOpen, onClose, onConfirm, title, body, showDontShowAgain, onDontShowAgainChange}"
    last_verified_session: 86

  WorkspaceIconSidebar.jsx:
    path: frontend/src/components/WorkspaceIconSidebar.jsx
    lines: 98
    purpose: "Narrow left icon bar for workspace panel switching"
    last_verified_session: 86

  ProjectSidebar.jsx:
    path: frontend/src/components/ProjectSidebar.jsx
    lines: 108
    purpose: "Legacy sidebar (may be deprecated)"
    last_verified_session: 86

  VoiceInput.jsx:
    path: frontend/src/components/VoiceInput.jsx
    lines: 172
    purpose: "Web Speech API voice input with useVoice hook"
    exports: ["VoiceInput (default)", "useVoice (named)"]
    last_verified_session: 86

  CodespacesManager.jsx:
    path: frontend/src/components/CodespacesManager.jsx
    lines: 332
    purpose: "GitHub Codespaces management UI"
    props: "{githubToken, onOpenInBrowser, onPreview}"
    last_verified_session: 86

  AnthropicSubscription.jsx:
    path: frontend/src/components/AnthropicSubscription.jsx
    lines: 418
    purpose: "Anthropic Pro subscription status — reads VPS servers from localStorage to show real Claude Code detection status"
    props: "{user}"
    key_state:
      - {name: vpsServers, type: "useState([])", drives: "VPS list from localStorage"}
    derived_state:
      - {name: isConnected, source: "claudeCodeVps.length > 0", desc: "true if any VPS has claudeCodeDetected"}
      - {name: hasVps, source: "connectedVps.length > 0", desc: "true if any VPS passed test connection"}
    localStorage_keys:
      - {key: vps_servers, direction: read}
    last_verified_session: 94

  StatusLinePreview.jsx:
    path: frontend/src/components/StatusLinePreview.jsx
    lines: 89
    purpose: "Reusable HTML/CSS mock of Claude Code terminal status line — shows location, folder, git, model, tokens, context bar, LIVE"
    props: "{serverName, folderName, branch, model, tokensUsed, tokensTotal} (all with defaults)"
    used_by: [Setup.jsx, Settings.jsx, CreateProject.jsx]
    last_verified_session: 94

  SettingsModal.jsx:
    path: frontend/src/components/SettingsModal.jsx
    lines: 169
    purpose: "Quick API key settings modal"
    props: "{apiKeys, onSave, onClose}"
    last_verified_session: 86

# ============================================================================
# FRONTEND — Contexts (frontend/src/contexts/)
# ============================================================================
frontend_contexts:
  AuthContext.jsx:
    path: frontend/src/contexts/AuthContext.jsx
    lines: 253
    purpose: "Auth state provider — JWT tokens, login/signup/logout, OAuth, token refresh. Tokens survive network errors (BUG-57) — only cleared on explicit 401."
    exports: ["AuthProvider (component)", "useAuth (hook)"]
    key_state:
      - {name: user, type: "useState(null)", drives: "authenticated user object"}
      - {name: loading, type: "useState(true)", drives: "initial auth check"}
      - {name: error, type: "useState(null)", drives: "auth errors"}
      - {name: connectionError, type: "useState(false)", drives: "backend unreachable state (BUG-57)"}
      - {name: isMounted, type: useRef, drives: "prevent state updates after unmount"}
    methods:
      - "fetchWithTimeout(url, options, timeout=10000)"
      - "login(email, password) → POST /api/auth/login"
      - "signup(email, password, name) → POST /api/auth/signup"
      - "logout() → POST /api/auth/logout"
      - "refreshAccessToken() → POST /api/auth/refresh"
      - "fetchUser(isRetry=false) → GET /api/auth/me"
      - "retryAuth() → reset connectionError + re-fetch user (BUG-57)"
      - "handleOAuthCallback(accessToken, refreshToken)"
      - "getAuthHeader() → {Authorization: Bearer ...}"
    localStorage_keys:
      - {key: access_token, direction: both}
      - {key: refresh_token, direction: both}
    critical_patterns:
      - "isMounted ref prevents state update after unmount"
      - "isRetry flag prevents infinite token refresh loop"
      - "fetchWithTimeout with AbortController on all requests"
    last_verified_session: 86

# ============================================================================
# FRONTEND — Assets (frontend/src/assets/)
# ============================================================================
frontend_assets:
  _note: "SVG brand logos used in Setup wizard PathCards. Imported via Vite as URL strings."
  claude-code-logo.svg:
    path: frontend/src/assets/claude-code-logo.svg
    purpose: "Claude Code brand logo (orange #db7658 pixel face, transparent bg) — used on Anthropic Pro PathCard in Setup wizard"
    original_location: "repo root Claude_Code_Logo_White_tp.svg (moved by UI-07)"
    used_by: [Setup.jsx]
    note: "Cleaned: removed XML declaration/DOCTYPE. viewBox 0 0 165 144 (roughly square). Renders at 24x24 with objectFit:contain."
  openrouter-logo.svg:
    path: frontend/src/assets/openrouter-logo.svg
    purpose: "OpenRouter icon mark only (blue #0a5aec arrows) — used on OpenRouter PathCard in Setup wizard"
    original_location: "repo root openrouter-logo-v2.svg (moved by UI-07, cropped to icon mark)"
    used_by: [Setup.jsx]
    note: "Cropped from full wordmark (833x128) to icon mark only (152x128). Cleaned: removed XML declaration/DOCTYPE and text paths. Renders at 24x24 with objectFit:contain."

# ============================================================================
# BACKEND — Routers (backend/routers/)
# ============================================================================
backend_routers:
  auth.py:
    path: backend/routers/auth.py
    lines: 566
    prefix: "/api/auth"
    purpose: "Authentication — email/password, JWT, GitHub/Google OAuth, email verification, password reset"
    endpoints:
      - {method: POST, path: "/signup", purpose: "register new user"}
      - {method: POST, path: "/login", purpose: "login with credentials"}
      - {method: POST, path: "/logout", purpose: "logout (client-side)"}
      - {method: POST, path: "/refresh", purpose: "refresh access token"}
      - {method: GET, path: "/me", purpose: "get current user"}
      - {method: PUT, path: "/me", purpose: "update profile"}
      - {method: POST, path: "/me/setup-complete", purpose: "mark setup wizard done"}
      - {method: POST, path: "/verify-email", purpose: "verify email token"}
      - {method: POST, path: "/resend-verification", purpose: "resend verification email"}
      - {method: POST, path: "/forgot-password", purpose: "request password reset"}
      - {method: POST, path: "/reset-password", purpose: "reset password with token"}
      - {method: GET, path: "/oauth/github", purpose: "GitHub OAuth redirect"}
      - {method: GET, path: "/oauth/github/callback", purpose: "GitHub OAuth callback"}
      - {method: GET, path: "/oauth/github/popup/callback", purpose: "GitHub OAuth popup callback"}
      - {method: GET, path: "/oauth/google", purpose: "Google OAuth redirect"}
      - {method: GET, path: "/oauth/google/callback", purpose: "Google OAuth callback"}
      - {method: GET, path: "/oauth/providers", purpose: "list available OAuth providers"}
    called_by_frontend: [AuthContext.jsx, AuthPage.jsx, AuthCallback.jsx, Setup.jsx]
    db_tables: [users]
    security: "Password validation: min 8 chars, 1 uppercase, 1 number, 1 special char"
    last_verified_session: 86

  chat.py:
    path: backend/routers/chat.py
    lines: 172
    prefix: "/api/chat"
    purpose: "Chat completions — routes to OpenRouter, Claude Direct, or Claude Code SSH"
    endpoints:
      - {method: POST, path: "/completions", purpose: "send chat (streaming SSE)"}
      - {method: GET, path: "/models", purpose: "list available models"}
      - {method: GET, path: "/usage", purpose: "get API usage/credits"}
    providers:
      - "openrouter (default) — via OpenRouterService"
      - "claude_direct — via ClaudeDirectService"
      - "claude_code_ssh — via ClaudeCodeSSHService (needs server_id)"
    streaming_format: "SSE: data: {json} then data: [DONE]"
    called_by_frontend: [Chat.jsx, CreateProject.jsx]
    last_verified_session: 86

  projects.py:
    path: backend/routers/projects.py
    lines: 1661
    prefix: "/api/projects"
    purpose: "Project CRUD with chat history, VPS folder auto-creation, harness template scaffolding (FEAT-30), project export (FEAT-51). Engineer systemPrompt (FEAT-54). Director auto-scaffold (FEAT-55). Improved PRP intake with navigation, review gate, approval gate, user profiling (FEAT-53)."
    endpoints:
      - {method: GET, path: "/", purpose: "list all projects"}
      - {method: POST, path: "/", purpose: "create project (+ scaffold harness on VPS + Director dir)"}
      - {method: GET, path: "/{id}", purpose: "get specific project"}
      - {method: PATCH, path: "/{id}", purpose: "update project"}
      - {method: DELETE, path: "/{id}", purpose: "delete project"}
      - {method: GET, path: "/{id}/history", purpose: "get chat history"}
      - {method: POST, path: "/{id}/history", purpose: "add chat message"}
      - {method: DELETE, path: "/{id}/history", purpose: "clear chat history"}
      - {method: GET, path: "/{id}/export", purpose: "FEAT-51: export project as tar.gz download from VPS"}
    helpers: "create_vps_project_folder(vps_server_id, slug, name, tech_stack, brief) — SSH mkdir + scaffold 11 harness template files + git init + Director directory with 3 files (FEAT-55). _detect_commands(tech_stack) — returns install/start commands. _fill_template(template, vars) — replaces {{placeholders}}. _cleanup_export(conn, path) — best-effort temp file cleanup."
    template_constants: "TEMPLATE_CLAUDE_MD, TEMPLATE_CLAUDE_SETTINGS (FEAT-54), TEMPLATE_GENERATE_PRP (FEAT-53), TEMPLATE_EXECUTE_PRP, TEMPLATE_FEATURE_QUEUE, TEMPLATE_CODEBASE_INDEX, TEMPLATE_LEARNINGS, TEMPLATE_README, TEMPLATE_ROADMAP (FEAT-57), TEMPLATE_PORTABLE_README, TEMPLATE_DIRECTOR_CLAUDE_MD (FEAT-55), TEMPLATE_DIRECTOR_SETTINGS (FEAT-55), TEMPLATE_DIRECTOR_SETTINGS_LOCAL (FEAT-55), TEMPLATE_CODE_RESEARCHER (FEAT-56), TEMPLATE_AUDIT_INDEX"
    called_by_frontend: [App.jsx, Dashboard.jsx, CreateProject.jsx, Workspace.jsx, WorkspaceFileExplorer.jsx, ExportModal.jsx]
    db_tables: [projects, chat_messages, vps_servers]
    last_verified_session: 144

  ssh.py:
    path: backend/routers/ssh.py
    lines: 713
    prefix: "/api/ssh"
    purpose: "SSH server management, Claude Code detection, status line hook install, legacy terminal WebSocket, SFTP file ops"
    endpoints:
      - {method: GET, path: "/servers", purpose: "list all servers"}
      - {method: POST, path: "/servers", purpose: "add new server"}
      - {method: DELETE, path: "/servers/{id}", purpose: "remove server"}
      - {method: POST, path: "/servers/{id}/connect", purpose: "establish SSH connection"}
      - {method: POST, path: "/servers/{id}/disconnect", purpose: "disconnect from server"}
      - {method: GET, path: "/servers/{id}/claude-code", purpose: "detect Claude Code installation"}
      - {method: POST, path: "/servers/{id}/status-line", purpose: "install/uninstall status line hook via SSH+SFTP"}
      - {method: POST, path: "/test", purpose: "test SSH connection (no store), also runs 'which claude' and returns claude_code_detected"}
      - {method: WS, path: "/servers/{id}/terminal", purpose: "WebSocket terminal (legacy)"}
      - {method: GET, path: "/servers/{id}/files", purpose: "list files via SFTP"}
      - {method: GET, path: "/servers/{id}/files/read", purpose: "read file via SFTP"}
      - {method: POST, path: "/servers/{id}/files/write", purpose: "write file via SFTP"}
      - {method: DELETE, path: "/servers/{id}/files", purpose: "delete file/dir"}
      - {method: POST, path: "/servers/{id}/files/mkdir", purpose: "create directory"}
      - {method: POST, path: "/servers/{id}/files/rename", purpose: "rename/move file"}
    called_by_frontend: [Workspace.jsx, WorkspaceFileExplorer.jsx, DashboardSidebar.jsx, WorkspaceTopBar.jsx, Setup.jsx, CreateProject.jsx, Settings.jsx]
    db_tables: [vps_servers]
    last_verified_session: 94

  terminal.py:
    path: backend/routers/terminal.py
    lines: 300
    prefix: "/api/terminal"
    purpose: "Multiplexed terminal — one SSH connection per VPS, multiple PTY channels. FEAT-49: sends cwd in connected message."
    endpoints:
      - {method: WS, path: "/ws", purpose: "interactive terminal WebSocket (multiplexed)"}
      - {method: GET, path: "/status", purpose: "terminal sessions status"}
      - {method: GET, path: "/connections/{id}", purpose: "specific connection status"}
    websocket_protocol:
      init: "{type: 'init', cols: 80, rows: 24}"
      input: "{type: 'input', data: 'cmd\\n'}"
      output: "{type: 'output', data: '...'}"
      resize: "{type: 'resize', cols, rows}"
      connected: "{type: 'connected', server, host, channel_id, connection_channels, cwd}"
      status: "{type: 'connection_status', status, message}"
    error_codes: "4000=missing params, 4003=SSH failed, 4004=not found, 4008=timeout"
    uses_service: vps_connection.py
    called_by_frontend: [ClaudeCodeTerminalChat.jsx, MultiTerminal.jsx, WorkspaceTerminal.jsx]
    db_tables: [projects, vps_servers]
    last_verified_session: 136

  servers.py:
    path: backend/routers/servers.py
    lines: 411
    prefix: "/api/servers"
    purpose: "Alternative VPS server CRUD with upsert, file ops, and terminal WebSocket"
    endpoints:
      - {method: GET, path: "/", purpose: "list all servers"}
      - {method: POST, path: "/", purpose: "create/upsert server"}
      - {method: GET, path: "/{id}", purpose: "get server details"}
      - {method: PATCH, path: "/{id}", purpose: "update server"}
      - {method: DELETE, path: "/{id}", purpose: "delete server"}
      - {method: POST, path: "/{id}/test", purpose: "test connection"}
      - {method: GET, path: "/{id}/files", purpose: "list files"}
      - {method: GET, path: "/{id}/files/read", purpose: "read file"}
      - {method: POST, path: "/{id}/files/write", purpose: "write file"}
      - {method: POST, path: "/{id}/files/mkdir", purpose: "create directory"}
      - {method: POST, path: "/{id}/files/delete", purpose: "delete file/dir"}
      - {method: POST, path: "/{id}/files/rename", purpose: "rename file/dir"}
      - {method: WS, path: "/{id}/terminal", purpose: "WebSocket terminal"}
    db_tables: [vps_servers]
    last_verified_session: 86

  files.py:
    path: backend/routers/files.py
    lines: 266
    prefix: "/api/files"
    purpose: "VPS file browser — resolves server from serverId or projectId"
    endpoints:
      - {method: GET, path: "/", purpose: "list directory"}
      - {method: GET, path: "/content", purpose: "read file (10MB max)"}
      - {method: PUT, path: "/content", purpose: "write file"}
      - {method: POST, path: "/mkdir", purpose: "create directory"}
      - {method: DELETE, path: "/", purpose: "delete file/dir"}
    helpers: "resolve_server_id(server_id, project_id) — get server from project if needed"
    called_by_frontend: [FileBrowser.jsx, WorkspaceFileExplorer.jsx, LLMDevPanel.jsx]
    db_tables: [projects, vps_servers]
    last_verified_session: 86

  github.py:
    path: backend/routers/github.py
    lines: 239
    prefix: "/api/github"
    purpose: "GitHub integration — user info, Codespaces CRUD, repos"
    endpoints:
      - {method: GET, path: "/user", purpose: "get GitHub user"}
      - {method: GET, path: "/codespaces", purpose: "list codespaces"}
      - {method: GET, path: "/codespaces/{name}", purpose: "get codespace"}
      - {method: POST, path: "/codespaces/{name}/start", purpose: "start codespace"}
      - {method: POST, path: "/codespaces/{name}/stop", purpose: "stop codespace"}
      - {method: POST, path: "/codespaces", purpose: "create codespace"}
      - {method: DELETE, path: "/codespaces/{name}", purpose: "delete codespace"}
      - {method: GET, path: "/repos", purpose: "list user repos"}
      - {method: POST, path: "/repos", purpose: "create repo"}
      - {method: GET, path: "/repos/{owner}/{repo}/machines", purpose: "machine types"}
    called_by_frontend: [CodespacesManager.jsx]
    last_verified_session: 86

  ai.py:
    path: backend/routers/ai.py
    lines: 345
    prefix: "/api/ai"
    purpose: "AI-powered project brief expansion and interactive planning chat. PRP_SYSTEM_PROMPT for adaptive intake flow, mode param on /chat (FEAT-32)"
    endpoints:
      - {method: POST, path: "/expand-brief", purpose: "analyze brief, generate project config (openrouter, claude_direct, or claude_code_ssh)"}
      - {method: POST, path: "/chat", purpose: "continue planning conversation (SSE, all 3 providers)"}
    providers:
      - "openrouter (default) — via OpenRouterService"
      - "claude_direct — via ClaudeDirectService"
      - "claude_code_ssh — via ClaudeCodeSSHService (needs server_id, collects async chunks for expand-brief)"
    request_models:
      - "ExpandBriefRequest: brief, model, provider, server_id"
      - "AIChatRequest: messages, brief, project_context, model, provider, server_id"
    called_by_frontend: [CreateProject.jsx]
    last_verified_session: 103

  stats.py:
    path: backend/routers/stats.py
    lines: 165
    prefix: "/api/stats"
    purpose: "Dashboard statistics and OpenRouter API key verification"
    endpoints:
      - {method: GET, path: "/dashboard", purpose: "dashboard stats (projects, tokens, agents)"}
      - {method: POST, path: "/verify-api-key", purpose: "verify OpenRouter API key"}
    external_api: "https://openrouter.ai/api/v1/auth/key"
    called_by_frontend: [Dashboard.jsx]
    db_tables: [projects]
    last_verified_session: 86

  settings.py:
    path: backend/routers/settings.py
    lines: 131
    prefix: "/api/settings"
    purpose: "Key-value user settings store + idle timeout config"
    endpoints:
      - {method: GET, path: "/", purpose: "list all settings"}
      - {method: GET, path: "/{key}", purpose: "get setting by key"}
      - {method: PUT, path: "/{key}", purpose: "set setting"}
      - {method: DELETE, path: "/{key}", purpose: "delete setting"}
      - {method: POST, path: "/bulk", purpose: "update multiple settings"}
      - {method: POST, path: "/idle-timeout", purpose: "enable/disable idle connection timeout at runtime"}
      - {method: GET, path: "/idle-timeout", purpose: "get idle timeout status"}
    called_by_frontend: [Settings.jsx]
    db_tables: [user_settings]
    last_verified_session: 93

  waitlist.py:
    path: backend/routers/waitlist.py
    lines: 39
    prefix: "/api/waitlist"
    purpose: "VibeShip.cloud beta waitlist email signup — no auth required"
    endpoints:
      - {method: POST, path: "/", purpose: "add email to waitlist (deduplicates)"}
    called_by_frontend: [Setup.jsx]
    db_tables: [waitlist_signups]
    last_verified_session: 114

  voice.py:
    path: backend/routers/voice.py
    lines: 90
    prefix: "/api/voice"
    purpose: "Voice transcription — optional server-side Whisper"
    endpoints:
      - {method: POST, path: "/transcribe", purpose: "transcribe audio via OpenAI Whisper"}
      - {method: GET, path: "/info", purpose: "voice capabilities info"}
    external_api: "https://api.openai.com/v1/audio/transcriptions"
    called_by_frontend: [VoiceInput.jsx]
    last_verified_session: 86

# ============================================================================
# BACKEND — Services (backend/services/)
# ============================================================================
backend_services:
  vps_connection.py:
    path: backend/services/vps_connection.py
    lines: 443
    purpose: "Multiplexed SSH connection manager — singleton, one connection per VPS, multiple PTY channels, idle timeout auto-close"
    classes:
      ConnectionStatus:
        type: Enum
        values: [DISCONNECTED, CONNECTING, CONNECTED, ERROR]
      SSHCredentials:
        type: dataclass
        fields: [host, port, username, password, private_key, passphrase]
      PTYChannel:
        type: dataclass
        fields: [id(UUID), process, cols, rows]
        methods: [read_output, write_input, resize, close]
      VPSConnection:
        purpose: "One SSH connection per VPS with multiple PTY channels"
        key_state:
          - "conn: asyncssh.SSHClientConnection"
          - "_sftp: asyncssh.SFTPClient (lazy)"
          - "channels: dict[str, PTYChannel]"
          - "status: ConnectionStatus"
          - "_status_listeners: list[Callable]"
          - "_connect_lock: asyncio.Lock"
          - "last_activity: float (time.time(), updated by touch())"
        methods:
          - "connect(timeout=15.0) — establish SSH with lock"
          - "create_channel(cols=80, rows=24) → PTYChannel"
          - "get_channel(channel_id) → Optional[PTYChannel]"
          - "close_channel(channel_id) — close channel not connection"
          - "get_sftp() → SFTPClient (lazy init)"
          - "run_command(command, timeout=10.0) → (stdout, stderr, exit_code)"
          - "close() — close all channels + connection"
      VPSConnectionManager:
        purpose: "Singleton managing all VPS connections with idle timeout"
        pattern: "Singleton via __new__"
        key_state:
          - "_connections: dict[str, VPSConnection]"
          - "_lock: asyncio.Lock (lazy)"
          - "idle_timeout: int (default 7200s / 2 hours)"
          - "_idle_checker_task: asyncio.Task (background loop every 300s)"
        methods:
          - "get_connection(server_id, credentials) → VPSConnection"
          - "get_existing_connection(server_id) → Optional[VPSConnection]"
          - "close_connection(server_id)"
          - "close_all()"
          - "get_status(server_id) → (ConnectionStatus, error_msg)"
          - "get_all_statuses() → dict"
          - "start_idle_checker() — starts background task (called from app lifespan)"
          - "stop_idle_checker() — cancels background task"
    global_instance: "vps_manager = VPSConnectionManager()"
    last_verified_session: 93

  ssh.py:
    path: backend/services/ssh.py
    lines: 354
    purpose: "Legacy SSH service — SSHConnection class, servers_cache, SFTP operations. write_file uses 'wb' mode and handles both str and bytes (BUG-49). delete_directory_recursive uses rm -rf with safety check (BUG-50)."
    key_exports:
      - "servers_cache: dict[str, dict] — in-memory server cache"
      - "load_server_to_cache(server_model)"
      - "remove_from_cache(server_id)"
      - "get_connection(server_id) → SSHConnection"
    last_verified_session: 86

  claude_code_ssh.py:
    path: backend/services/claude_code_ssh.py
    lines: 224
    purpose: "Routes chat through Claude Code CLI on VPS via SSH"
    class: ClaudeCodeSSHService
    method: "chat(conn, messages, model, max_tokens) → AsyncGenerator[str]"
    pattern: "Runs 'claude -p prompt --max-tokens N' via SSH, streams output as SSE"
    last_verified_session: 86

  auth.py:
    path: backend/services/auth.py
    lines: 503
    purpose: "Auth service — JWT creation, password hashing, OAuth clients, user helpers"
    key_exports:
      - "create_access_token(data) / create_refresh_token(data)"
      - "verify_token(token, token_type)"
      - "hash_password(password) / verify_password(plain, hashed)"
      - "user_to_response(user) → UserResponse"
      - "github_oauth_client / google_oauth_client"
    last_verified_session: 86

  openrouter.py:
    path: backend/services/openrouter.py
    lines: 186
    purpose: "OpenRouter API integration — chat completions, model listing, usage"
    class: OpenRouterService
    methods:
      - "chat(messages, model, api_key, stream, temperature, max_tokens)"
      - "list_models(api_key)"
      - "get_usage(api_key)"
    last_verified_session: 86

  github.py:
    path: backend/services/github.py
    lines: 221
    purpose: "GitHub API service — user info, Codespaces CRUD, repos, OAuth"
    class: GitHubService
    last_verified_session: 86

# ============================================================================
# BACKEND — Templates (backend/templates/)
# ============================================================================
backend_templates:
  status_line_hook.py:
    path: backend/templates/status_line_hook.py
    lines: 176
    purpose: "Generalized Claude Code status line hook — reads stdin JSON from Claude Code, outputs ANSI-colored status line"
    features: [hostname_auto_detect, git_branch_dirty_ahead_behind, model_parsing, token_bar, live_pulse]
    installed_to: "~/.claude/hooks/status_line.py on VPS via POST /api/ssh/servers/{id}/status-line"
    no_dependencies: true
    last_verified_session: 94

# ============================================================================
# BACKEND — Main (backend/main.py)
# ============================================================================
backend_main:
  path: backend/main.py
  lines: 66
  purpose: "FastAPI app setup — CORS, router registration, DB init/close lifecycle"
  cors_origins: ["http://localhost:5173", "http://localhost:3000"]
  routers_registered:
    - {prefix: "/api/auth", router: auth}
    - {prefix: "/api/chat", router: chat}
    - {prefix: "/api/projects", router: projects}
    - {prefix: "/api/ssh", router: ssh}
    - {prefix: "/api/servers", router: servers}
    - {prefix: "/api/github", router: github}
    - {prefix: "/api/files", router: files}
    - {prefix: "/api/settings", router: settings}
    - {prefix: "/api/ai", router: ai}
    - {prefix: "/api/stats", router: stats}
    - {prefix: "/api/terminal", router: terminal}
    - {prefix: "/api/voice", router: voice}
  lifecycle:
    startup: "init_db() — create tables (Postgres or SQLite), then run_migrations() for pending migration scripts"
    shutdown: "close_db() — dispose engine"
  last_verified_session: 90

# ============================================================================
# DEPLOYMENT — Production Infrastructure
# ============================================================================
deployment:
  config_file: docker-compose.yml
  orchestrator: "Coolify (auto-deploys from main branch)"
  reverse_proxy: "Traefik (HTTPS termination, routing for hubllm.dev)"
  domain: "hubllm.dev (https://www.hubllm.dev)"

  containers:
    backend:
      image: "python:3.12-slim (backend/Dockerfile)"
      port: 8000
      command: "uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
      volumes: ["./backend:/app"]
      depends_on: [db, redis]

    frontend:
      image: "node:20-alpine (frontend/Dockerfile)"
      port: 5173
      command: "npm run dev -- --host"
      volumes: ["./frontend:/app", "/app/node_modules"]

    db:
      image: "postgres:16-alpine"
      port: 5432
      credentials: {user: hubllm, password: hubllm, database: hubllm}
      volume: "postgres_data:/var/lib/postgresql/data"

    redis:
      image: "redis:7-alpine"
      port: 6379
      volume: "redis_data:/data"

  environment_variables:
    DATABASE_URL: "postgresql://hubllm:hubllm@db:5432/hubllm"
    REDIS_URL: "redis://redis:6379"
    FRONTEND_URL: "http://localhost:5173 (controls CORS origins in main.py)"
    APP_URL: "https://hubllm.dev"

  dual_db_rule: |
    Production uses Postgres 16. Local dev uses SQLite.
    SQLAlchemy create_all() only creates NEW tables — it never adds columns to existing Postgres tables.
    Every ORM model change MUST include a migration script in backend/migrations/.
    init_db() uses IS_POSTGRES flag to select information_schema (Postgres) or sqlite_master (SQLite) for table verification.
    DATABASE_URL is auto-converted: plain postgresql:// gets +asyncpg for async engine; SYNC_DATABASE_URL strips +asyncpg for psycopg2.
    run_migrations() runs all backend/migrations/NNN_*.py scripts (sorted, idempotent) after create_all on every startup.

  production_schema_history: |
    The production Postgres DB was originally created by an older version of the code that used UUID column types
    and had different tables (api_keys, servers). The current ORM uses String(64)/VARCHAR(64) for IDs.
    Session 90: All UUID columns were manually converted to VARCHAR(64) via ALTER TABLE on the production DB.
    Legacy tables (api_keys, servers) still exist in production but are NOT in the current ORM — harmless.
    Production tables (verified session 90): api_keys, chat_messages, projects, servers, user_settings, users, vps_servers
    ORM tables (5): chat_messages, projects, user_settings, users, vps_servers

  container_names_coolify: |
    Coolify generates long container names. Use 'docker ps --filter name=backend-' etc.
    NEVER use 'docker restart' on Coolify containers — it breaks Traefik routing labels.
    ALWAYS redeploy via Coolify dashboard or 'git push origin main' to trigger proper redeploy.
    NEVER add domains to Coolify UI for the frontend service — Coolify beta.459 generates
    broken Traefik labels (Host('')). All routing is managed in docker-compose.yml.

  migrations:
    directory: backend/migrations/
    pattern: "NNN_description.py with migrate(engine) function"
    existing:
      - {file: "001_add_setup_completed.py", purpose: "Adds setup_completed BOOLEAN column to users table if missing"}
      - {file: "002_fix_uuid_columns.py", purpose: "Converts UUID columns to VARCHAR(64) in Postgres — idempotent, skips SQLite"}
      - {file: "003_add_projects_columns.py", purpose: "Adds 10 missing columns to projects table in Postgres (slug, brief, workspace, connection_type, github_repo, vps_server_id, agent_ids, mcp_server_ids, status, selected_model) — idempotent, skips SQLite"}
      - {file: "004_fix_projects_user_id.py", purpose: "Makes projects.user_id nullable in Postgres (DROP NOT NULL) — original table had user_id NOT NULL but ORM model removed the field, causing INSERT failures. Idempotent, skips SQLite"}
    execution: "run_migrations() in backend/models/__init__.py — runs on every startup after create_all"

  last_verified_session: 92

# ============================================================================
# DATABASE SCHEMA (SQLAlchemy ORM — backend/models/__init__.py)
# ============================================================================
database:
  engine: "SQLite (aiosqlite) in dev — backend/hubllm.db (absolute path via Path(__file__)); Postgres 16 in production via DATABASE_URL env var (docker-compose.yml). CRITICAL: create_all() does NOT add columns to existing Postgres tables — every schema change needs a migration script."
  orm: "SQLAlchemy async with mapped_column"
  init_db_flow:
    - "1. IS_POSTGRES flag set from DATABASE_URL prefix"
    - "2. Async engine uses +asyncpg (Postgres) or +aiosqlite (SQLite)"
    - "3. Sync engine uses plain postgresql:// (Postgres) or sqlite:// (SQLite) for DDL"
    - "4. create_all() creates missing tables via sync engine"
    - "5. Table verification via information_schema (Postgres) or sqlite_master (SQLite)"
    - "6. run_migrations() executes backend/migrations/NNN_*.py scripts in order"
  production_legacy_tables:
    - {name: api_keys, note: "Legacy — not in ORM, has id/user_id columns. Harmless."}
    - {name: servers, note: "Legacy — not in ORM, has id/user_id columns. Replaced by vps_servers."}
  production_schema_fixes_applied:
    - {session: 90, fix: "All UUID columns converted to VARCHAR(64) — users.id, projects.id, projects.user_id, api_keys.*, servers.*, chat_messages.*"}
    - {session: 90, fix: "FK constraints dropped and columns retyped (projects_user_id_fkey, api_keys_user_id_fkey, servers_user_id_fkey)"}
    - {session: 90, fix: "chat_messages table dropped and recreated with INTEGER autoincrement id (was UUID)"}
  tables:
    users:
      columns:
        - {name: id, type: "String(64)", pk: true, default: "uuid4().hex"}
        - {name: email, type: "String(255)", unique: true}
        - {name: password_hash, type: "String(255)", nullable: true}
        - {name: name, type: "String(255)", nullable: true}
        - {name: avatar_url, type: "String(500)", nullable: true}
        - {name: auth_provider, type: "Enum(LOCAL,GITHUB,GOOGLE)", default: LOCAL}
        - {name: oauth_id, type: "String(255)", nullable: true}
        - {name: email_verified, type: Boolean, default: false}
        - {name: verification_token, type: "String(255)", nullable: true}
        - {name: verification_expires, type: DateTime, nullable: true}
        - {name: reset_token, type: "String(255)", nullable: true}
        - {name: reset_expires, type: DateTime, nullable: true}
        - {name: setup_completed, type: Boolean, default: false}
        - {name: created_at, type: DateTime, default: utcnow}
        - {name: last_login, type: DateTime, nullable: true}
      relationships: []

    vps_servers:
      columns:
        - {name: id, type: "String(64)", pk: true}
        - {name: name, type: "String(255)"}
        - {name: host, type: "String(255)"}
        - {name: port, type: Integer, default: 22}
        - {name: username, type: "String(255)", default: "root"}
        - {name: auth_type, type: "String(50)", default: "key"}
        - {name: password, type: Text, nullable: true}
        - {name: private_key, type: Text, nullable: true}
        - {name: passphrase, type: Text, nullable: true}
        - {name: last_test_success, type: Boolean, default: false}
        - {name: server_info, type: "Text (JSON)", nullable: true}
        - {name: created_at, type: DateTime, default: utcnow}
      relationships:
        - {name: projects, type: "1:N → Project"}

    projects:
      columns:
        - {name: id, type: "String(64)", pk: true}
        - {name: name, type: "String(255)"}
        - {name: slug, type: "String(255)"}
        - {name: description, type: Text, nullable: true}
        - {name: brief, type: Text, nullable: true}
        - {name: workspace, type: "String(255)", default: "default"}
        - {name: color, type: "String(7)", default: "#3B82F6"}
        - {name: connection_type, type: "String(50)", default: "github"}
        - {name: github_repo, type: "String(255)", nullable: true}
        - {name: vps_server_id, type: "String(64)", fk: "vps_servers.id"}
        - {name: context, type: "Text (JSON)", nullable: true}
        - {name: agent_ids, type: "Text (JSON array)", nullable: true}
        - {name: mcp_server_ids, type: "Text (JSON array)", nullable: true}
        - {name: status, type: "String(50)", default: "active"}
        - {name: selected_model, type: "Text (JSON)", nullable: true}
        - {name: created_at, type: DateTime, default: utcnow}
        - {name: updated_at, type: DateTime, default: utcnow}
      relationships:
        - {name: vps_server, type: "N:1 → VPSServer"}
        - {name: messages, type: "1:N → ChatMessage (cascade delete)"}

    chat_messages:
      columns:
        - {name: id, type: Integer, pk: true, autoincrement: true}
        - {name: project_id, type: "String(64)", fk: "projects.id"}
        - {name: role, type: "String(50)"}
        - {name: content, type: Text}
        - {name: model, type: "String(100)", nullable: true}
        - {name: timestamp, type: DateTime, default: utcnow}
      relationships:
        - {name: project, type: "N:1 → Project"}

    user_settings:
      columns:
        - {name: id, type: Integer, pk: true, autoincrement: true}
        - {name: key, type: "String(255)", unique: true}
        - {name: value, type: Text, nullable: true}

    waitlist_signups:
      columns:
        - {name: id, type: "String(64)", pk: true, default: "uuid4().hex"}
        - {name: email, type: "String(255)", unique: true, nullable: false, index: true}
        - {name: source, type: "String(64)", default: "setup_wizard"}
        - {name: created_at, type: DateTime, default: "datetime.utcnow"}
      migration: backend/migrations/005_add_waitlist_table.py

# ============================================================================
# DATA FLOW — localStorage
# ============================================================================
data_flow:
  localStorage_keys:
    access_token:
      type: String
      set_by: [AuthContext.jsx]
      read_by: [AuthContext.jsx]
      cleared_by: [AuthContext.jsx]
      sync_direction: "frontend-only — sent as Bearer header in API calls"

    refresh_token:
      type: String
      set_by: [AuthContext.jsx]
      read_by: [AuthContext.jsx]
      cleared_by: [AuthContext.jsx]
      sync_direction: "frontend-only — sent to /api/auth/refresh"

    vps_servers:
      type: "JSON Array of server objects"
      set_by: [Settings.jsx, Setup.jsx, CreateProject.jsx]
      read_by: [Settings.jsx, Workspace.jsx, LLMDevPanel.jsx, ServerManager.jsx, CreateProject.jsx, Setup.jsx]
      sync_direction: "frontend → backend on page load (VPSConnectionsSettings syncs to /api/ssh/servers)"
      source_of_truth: true
      bugs:
        - {desc: "Backend loses data on restart — localStorage is persistent source of truth", sessions: [43, 47]}

    openrouter_api_key:
      type: String
      set_by: [Settings.jsx]
      read_by: [Settings.jsx, WorkspaceTopBar.jsx, Dashboard.jsx]
      sync_direction: "frontend-only — sent as X-OpenRouter-Key header"
      note: "Primary key; see also legacy openrouter_key"

    openrouter_key:
      type: String
      set_by: [App.jsx, Setup.jsx, Settings.jsx]
      read_by: [App.jsx, WorkspaceTopBar.jsx, CreateProject.jsx, Settings.jsx, Setup.jsx]
      sync_direction: "frontend-only — legacy key, code checks both"
      note: "Legacy key — code checks openrouter_api_key || openrouter_key"

    claude_key:
      type: String
      set_by: [App.jsx]
      read_by: [App.jsx]
      sync_direction: "frontend-only"

    github_token:
      type: String
      set_by: [App.jsx]
      read_by: [App.jsx]
      sync_direction: "frontend-only — sent as X-GitHub-Token header"

    last_used_model:
      type: "JSON Object ({id, name, provider})"
      set_by: [Workspace.jsx]
      read_by: [Workspace.jsx]
      sync_direction: "frontend-only — fallback for new projects without saved model"

    hide_billing_switch_warning:
      type: "String ('true')"
      set_by: [WorkspaceTopBar.jsx]
      read_by: [WorkspaceTopBar.jsx]
      sync_direction: "frontend-only"

    openrouter_models:
      type: "JSON Array (cached OpenRouter model list)"
      set_by: [ModelSelector.jsx]
      read_by: [ModelSelector.jsx]
      sync_direction: "frontend-only — cached from https://openrouter.ai/api/v1/models"
      notes: "MODEL-04: 24h TTL cache. Manual refresh via footer button. Extracted from WorkspaceTopBar in FEAT-21."

    openrouter_models_fetched:
      type: "String (Unix timestamp ms)"
      set_by: [ModelSelector.jsx]
      read_by: [ModelSelector.jsx]
      sync_direction: "frontend-only — cache timestamp for 24h TTL"

    ai_assistant_alias:
      type: String
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    user_timezone:
      type: String
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    default_model:
      type: String
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    voice_input_enabled:
      type: "String ('true'/'false')"
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    theme:
      type: String
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    compact_mode:
      type: "String ('true'/'false')"
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    show_line_numbers:
      type: "String ('true'/'false')"
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

    mcp_servers:
      type: "JSON Array of MCP server objects"
      set_by: [Settings.jsx]
      read_by: [Settings.jsx, CreateProject.jsx]
      sync_direction: "frontend-only"

    global_agents:
      type: "JSON Array of agent objects"
      set_by: [Settings.jsx]
      read_by: [Settings.jsx, CreateProject.jsx]
      sync_direction: "frontend-only"

    global_skills:
      type: "JSON Array of skill objects"
      set_by: [Settings.jsx]
      read_by: [Settings.jsx]
      sync_direction: "frontend-only"

  note: "No sessionStorage is used anywhere in the codebase"

# ============================================================================
# CROSS-CUTTING — Billing & Model Routing Architecture
# ============================================================================
#
# This section documents how models are selected, how billing modes work,
# and how API calls are routed. MUST be updated when adding new subscription
# providers (e.g. OpenAI) or new API services (e.g. local LLM).
#
billing_and_routing:
  overview: |
    Two billing modes exist: "Pro Subscription" (Claude Code on VPS, free with Anthropic Pro)
    and "OpenRouter" (pay-per-call via API key). Models have a `tier` field that determines
    which billing mode they belong to.

    DUAL-PATH ARCHITECTURE (FEAT-24/25, Session 104):
    The two billing modes use fundamentally different UX paths:

    1. OpenRouter (stateless API): "Define Project with AI" button → inline AI chat in CreateProject
       → backend /api/ai/expand-brief + /api/ai/chat → provider:'openrouter' hardcoded (FEAT-26).
    2. Subscription/Claude Code (interactive terminal): "Enhance project with AI" checkbox →
       Create Project → redirect to workspace with ?enhance=true → ClaudeCodeTerminalChat shows
       banner with project brief → user copies prompt to clipboard → pastes into Claude Code terminal.

    Claude Code is SESSION-BASED and INTERACTIVE — it asks follow-up questions, needs yes/no
    confirmations, and runs as a terminal session. This is why CreateProject doesn't route
    subscription models through the API anymore. The old claude_code_ssh routing in CreateProject
    was removed in FEAT-26 (dead code after FEAT-24 hid the button for subscription models).

    In Workspace, subscription models still route through Chat.jsx → ClaudeCodeTerminalChat.jsx
    which connects via WebSocket to the VPS terminal. OpenRouter models route through Chat.jsx →
    standard chat UI → backend API.

  tiers:
    subscription:
      description: "Anthropic models routed through Claude Code CLI on user's VPS"
      defined_in: "ModelSelector.jsx SUBSCRIPTION_MODELS constant (5 models)"
      requires: "VPS with Claude Code installed + authenticated (claudeCodeDetected in localStorage vps_servers)"
      provider_value: "claude_code_ssh (only used in Workspace Chat.jsx path, NOT in CreateProject)"
      billing: "Free — uses user's Anthropic Pro subscription"
      service: "backend/services/claude_code_ssh.py → ClaudeCodeSSHService (Workspace path only)"
      streaming_only: true
      note: "ClaudeCodeSSHService.chat() returns AsyncGenerator. Non-streaming callers (expand-brief) must collect chunks."
      create_project_path: "Checkbox → URL ?enhance=true → ClaudeCodeTerminalChat banner → copy-to-clipboard (FEAT-24/25)"

    openrouter:
      description: "Any model from OpenRouter's catalog (500+ models, all providers)"
      defined_in: "ModelSelector.jsx POPULAR_MODEL_IDS (curated ~16) + full list from API"
      requires: "OpenRouter API key in localStorage (openrouter_key or openrouter_api_key)"
      provider_value: "openrouter"
      billing: "Pay-per-call — charged to user's OpenRouter account"
      service: "backend/services/openrouter.py → OpenRouterService"
      create_project_path: "'Define Project with AI' button → inline chat → /api/ai/expand-brief + /api/ai/chat"

    claude_direct:
      description: "Direct Anthropic API (legacy, rarely used)"
      requires: "Claude API key (claude_key in localStorage)"
      provider_value: "claude_direct"
      service: "backend/services/openrouter.py → ClaudeDirectService"

  routing_flow:
    create_project: |
      DUAL-PATH (FEAT-24/25/26/28):
      Track selector (BUG-48) — two clickable cards above brief:
      1. Terminal Track (selectedTrack='terminal'):
         - Card: Server icon + 'Use Your VPS + LLM CLI' + 'DETECTED' badge if hasClaudeCode
         - Below brief: hint '/generate-prp in the terminal for AI-guided project setup'
         - On Create: onCreateProject(project, { enhance: false }) — no browser-side enhancement
      2. OpenRouter Track (selectedTrack='openrouter'):
         - Card: Cloud icon + 'OpenRouter API Key'
         - Below brief: ModelSelector + 'Define Project with AI' button → PRP chat
         - No enhance checkbox needed — PRP flow happens inline before creation
         - "Define Project with AI" button shown (inline AI chat flow)
         - All 3 fetch calls hardcode provider:'openrouter'
         - POST /api/ai/expand-brief + /api/ai/chat with provider:'openrouter'
      Note: isSubscriptionModel and SUBSCRIPTION_MODELS import removed in FEAT-28.

    workspace_enhance: |
      ENHANCE BANNER (FEAT-25):
      1. App.jsx reads ?enhance=true from URL, captures in enhanceMode state, clears URL param (one-shot)
      2. Prop threading: App → Workspace → Chat → ClaudeCodeTerminalChat (enhanceWithAI prop)
      3. ClaudeCodeTerminalChat shows orange banner with truncated brief + "Copy to Clipboard" button
      4. User copies prompt, pastes into Claude Code terminal when ready
      5. Banner dismissed via "Dismiss" or auto-hides context (URL already cleared, won't reappear on refresh)
      Why copy-paste: WebSocket terminal injection is fragile (echo detection, timing, collision — BUBBLE-01 shelved for same reason)

    workspace_chat: |
      WORKSPACE ROUTING (unchanged):
      1. Chat.jsx checks: isAnthropicModel && claudeCodeStatus.authenticated && serverId
         - True → render ClaudeCodeTerminalChat (WebSocket terminal to VPS)
         - False → render standard chat UI (fetch to /api/ai/chat or /api/chat)
      2. provider is NOT set in CreateProject fetch calls for subscription models anymore

    backend_dispatch: |
      get_service(provider, api_keys, server_id) in ai.py and chat.py:
        - "claude_code_ssh" → ClaudeCodeSSHService(server_id) — 400 if no server_id
        - "claude_direct"   → ClaudeDirectService(api_keys["claude"]) — 401 if no key
        - else (openrouter) → OpenRouterService(api_keys["openrouter"]) — 401 if no key
      Note: CreateProject now only sends provider:'openrouter'. claude_code_ssh is only
      triggered from Workspace Chat.jsx path (not from CreateProject).

  # FILES TO MODIFY when adding a new subscription provider or API service:
  extension_checklist:
    new_subscription_provider:
      description: "e.g. adding OpenAI subscription models routed through a local CLI"
      files:
        - file: "frontend/src/components/ModelSelector.jsx"
          what: "Add models to SUBSCRIPTION_MODELS array with new tier value. Update billing toggle to show new provider tab. Update isModelAvailable() and getBillingLabel()."
        - file: "frontend/src/pages/CreateProject.jsx"
          what: "CreateProject no longer uses model tier — it checks hasClaudeCode (VPS detection). No changes needed for new subscription providers unless they require a different badge."
        - file: "frontend/src/components/Chat.jsx"
          what: "Update useClaudeCodeTerminal check (line ~24) to detect new provider's models."
        - file: "frontend/src/components/ClaudeCodeTerminalChat.jsx"
          what: "If new provider also uses terminal interaction, update enhance banner logic. If not, create a new terminal component."
        - file: "frontend/src/components/WorkspaceTopBar.jsx"
          what: "Update billing warning logic if switching to/from new provider."
        - file: "backend/routers/ai.py"
          what: "Add new provider to get_service(). Import new service class."
        - file: "backend/routers/chat.py"
          what: "Add new provider branch (lines 74-95)."
        - file: "backend/services/"
          what: "Create new service class implementing chat() method (must match AsyncGenerator or dict return patterns)."

    new_api_service:
      description: "e.g. adding a local LLM API or another cloud provider like Groq"
      files:
        - file: "frontend/src/components/ModelSelector.jsx"
          what: "Add new tier constant. Add models or fetch logic. Update billing toggle."
        - file: "frontend/src/pages/CreateProject.jsx"
          what: "If stateless API: add provider branch to the 3 fetch calls. If interactive: add to tier check for checkbox UI."
        - file: "backend/routers/ai.py + chat.py"
          what: "Add provider to get_service()."
        - file: "backend/services/"
          what: "New service class with chat() method."
        - file: "CODEBASE_INDEX.yaml"
          what: "Update this billing_and_routing section with new tier."

  # KEY DEPENDENCIES — what breaks if you change these
  dependencies:
    model_tier_field:
      description: "The 'tier' string on model objects ('subscription' | 'openrouter' | 'coming_soon')"
      set_in: "ModelSelector.jsx — SUBSCRIPTION_MODELS has tier:'subscription', parseOpenRouterModels sets tier:'openrouter'"
      read_in: [ModelSelector.jsx, WorkspaceTopBar.jsx]
      routing_impact: "In CreateProject: selectedTrack determines terminal hint vs ModelSelector (BUG-48). In Workspace: tier determines terminal vs API chat routing."

    provider_string:
      description: "The 'provider' field in POST request body ('claude_code_ssh' | 'openrouter' | 'claude_direct')"
      set_in: "CreateProject.jsx (hardcoded 'openrouter' after FEAT-26), Chat.jsx (from serverId/model detection)"
      read_in: "Backend get_service() in ai.py and chat.py"
      must_match: "Exact string match — typo = falls through to openrouter default"
      note: "CreateProject no longer sends 'claude_code_ssh' — subscription models use terminal path instead"

    server_id:
      description: "VPS server ID required for claude_code_ssh provider"
      set_in: "Chat.jsx (from serverId prop, derived in Workspace.jsx from project.vps_server_id)"
      read_in: "Backend get_service() → ClaudeCodeSSHService(server_id)"
      failure_mode: "Missing server_id + claude_code_ssh → 400 error"
      note: "No longer set in CreateProject.jsx (FEAT-26 removed subscription routing from fetch calls)"

    enhance_url_param:
      description: "?enhance=true URL parameter passed from CreateProject to Workspace"
      set_in: "App.jsx handleProjectCreated (FEAT-24) — appended when options.enhance is true"
      read_in: "App.jsx (captured to enhanceMode state, cleared from URL on mount)"
      threaded_to: "App → Workspace → Chat → ClaudeCodeTerminalChat (enhanceWithAI prop)"
      one_shot: "URL param cleared after first render via setSearchParams. State survives."

    api_keys_object:
      description: "{ openrouter: bool, anthropic: bool } passed to ModelSelector"
      set_in: "WorkspaceTopBar.jsx (from SSH endpoint + localStorage), CreateProject.jsx (from localStorage vps_servers)"
      controls: "Which models show as available/greyed, which billing toggle tab has green dot"

  # CROSS-REFERENCES to other index sections
  see_also:
    - section: "frontend_components > ModelSelector.jsx"
      for: "Full component API, props, state, constants"
    - section: "frontend_components > WorkspaceTopBar.jsx"
      for: "Claude Code status detection, billing warning modal"
    - section: "frontend_pages > CreateProject.jsx"
      for: "Track selection UI (BUG-48), selectedTrack state, OpenRouter-only fetch calls"
    - section: "frontend_components > ClaudeCodeTerminalChat.jsx"
      for: "Enhance banner, copyBriefToClipboard handler, showEnhanceBanner state"
    - section: "frontend_pages > App.jsx"
      for: "enhanceMode state, URL param capture/clear, handleProjectCreated options"
    - section: "backend_routers > ai.py"
      for: "get_service() dispatch, expand-brief streaming collection"
    - section: "backend_routers > chat.py"
      for: "Chat completions routing, SSE streaming"
    - section: "backend_services"
      for: "ClaudeCodeSSHService, OpenRouterService, ClaudeDirectService"
    - section: "data_flow > localStorage_keys > vps_servers"
      for: "claudeCodeDetected flag per server"
    - section: "data_flow > localStorage_keys > openrouter_key"
      for: "API key availability check"

  last_verified_session: 104
  added_by: "Director (FEAT-22/FEAT-23 review)"

# ============================================================================
# CROSS-CUTTING — Recurring Bug Patterns
# ============================================================================
recurring_bugs:
  - id: 1
    desc: "localStorage vs backend sync — backend loses data on restart"
    sessions: [43, 47, 53, 54, 55, 56]
    affected_files: [ServerManager.jsx, servers.py, Workspace.jsx, Settings.jsx]
    status: known_pattern
    note: "localStorage is source of truth for VPS servers — always sync FROM localStorage TO backend"

  - id: 2
    desc: "claudeCodeStatus timing — renders before async check completes"
    sessions: [81, 82]
    affected_files: [Chat.jsx, WorkspaceTopBar.jsx, Workspace.jsx]
    status: fixed
    fix: "Show 'Connecting to VPS...' welcome message while waiting (Option D)"

  - id: 3
    desc: "CSS overflow clips absolutely positioned dropdowns"
    sessions: [46]
    affected_files: []
    status: known_pattern

  - id: 4
    desc: "Stale closures in useEffect — use setState(prev => ...) functional updates"
    sessions: [63]
    affected_files: [LLMDevPanel.jsx, Workspace.jsx]
    status: fixed
    fix: "Use functional update pattern inside useEffect callbacks"

  - id: 5
    desc: "fitAddon.fit() must run AFTER container is visible — use requestAnimationFrame"
    sessions: [62]
    affected_files: [MultiTerminal.jsx, WorkspaceTerminal.jsx]
    status: fixed
    fix: "requestAnimationFrame + secondary delayed fit()"

  - id: 6
    desc: "Conditional rendering unmounts components with WebSocket connections"
    sessions: [65]
    affected_files: [LLMDevPanel.jsx]
    status: fixed
    fix: "Use CSS display:none instead of conditional rendering to preserve connections"

  - id: 7
    desc: "Flex children without minWidth:0 cause xterm width calculation overflow"
    sessions: [62]
    affected_files: [MultiTerminal.jsx, LLMDevPanel.jsx]
    status: fixed
    fix: "Add width:100%, minWidth:0, overflow:hidden to all flex containers with xterm"

  - id: 8
    desc: "SFTP read with text mode 'r' fails on .decode() — use binary 'rb'"
    sessions: [63]
    affected_files: [services/ssh.py]
    status: fixed
    fix: "Always use 'rb' mode for SFTP reads, then decode result"

  - id: 9
    desc: "linkedServerId not updating when project prop changes"
    sessions: [73]
    affected_files: [Workspace.jsx]
    status: fixed
    fix: "useEffect to sync linkedServerId from project.vps_server_id"

  - id: 10
    desc: "Non-memoized callbacks cause child useEffect re-runs"
    sessions: [63]
    affected_files: [Workspace.jsx, LLMDevPanel.jsx]
    status: fixed
    fix: "Wrap callbacks in useCallback with stable deps"

  - id: 11
    desc: "Auth fetch without timeout hangs UI when backend unresponsive"
    sessions: [51]
    affected_files: [AuthContext.jsx]
    status: fixed
    fix: "fetchWithTimeout using AbortController on all auth API calls"

  - id: 12
    desc: "Token refresh infinite loop — 401 → refresh → 401 → refresh..."
    sessions: [51]
    affected_files: [AuthContext.jsx]
    status: fixed
    fix: "isRetry flag on fetchUser prevents recursive refresh"

  - id: 13
    desc: "ORM model changes without DB migrations — create_all() only creates NEW tables, never adds columns to existing Postgres tables"
    sessions: [87]
    affected_files: [backend/models/__init__.py]
    status: known_pattern
    note: "Every model change (new column, type change, constraint) MUST include ALTER TABLE migration script. Production Postgres will silently ignore new columns added to ORM models. BUG-28 was caused by this."

  - id: 14
    desc: "SQLite-specific SQL in init_db() — sqlite_master doesn't exist in Postgres"
    sessions: [87, 89]
    affected_files: [backend/models/__init__.py]
    status: fixed
    note: "Fixed in BUG-28-REOPEN: init_db() now uses IS_POSTGRES flag to select information_schema.tables (Postgres) or sqlite_master (SQLite)."

  - id: 15
    desc: "SYNC_DATABASE_URL construction assumes SQLite — replace('+aiosqlite','') breaks Postgres URLs"
    sessions: [87, 89]
    affected_files: [backend/models/__init__.py]
    status: fixed
    note: "Fixed in BUG-28-REOPEN: URL handling now branches on IS_POSTGRES. Async URL gets +asyncpg, sync URL uses plain postgresql://."

  - id: 16
    desc: "Production Postgres had UUID column types — ORM expects VARCHAR(64)"
    sessions: [90, 91]
    affected_files: [backend/models/__init__.py, backend/migrations/002_fix_uuid_columns.py]
    status: fixed
    fix: "Manual fix on production DB (session 90) + migration script 002_fix_uuid_columns.py (session 91). Migration checks column types via inspect, drops FK constraints, ALTERs UUID→VARCHAR(64). Idempotent, skips SQLite."
    note: "Root cause: production DB was created by older code version using UUID types. ORM uses String(64). Migration now handles this automatically for any future DB recreations."

  - id: 17
    desc: "Coolify Traefik label poisoning — Host('') errors block all Docker-based routes"
    sessions: [90, 98, 99]
    affected_files: [docker-compose.yml]
    status: fixed
    fix: |
      Root cause: Coolify's Domains field for the frontend service was set to bare
      'hubllm.dev,www.hubllm.dev' without https:// prefix. This is a known Coolify bug
      (GitHub #5813, #7092, #7121) in beta.459 — the domain goes into PathPrefix() instead
      of Host(), generating broken labels: Host(``) && PathPrefix(`hubllm.dev`).
      Adding https:// prefix did NOT fix it in this Coolify version.

      Fix (Session 99): Cleared the Coolify Domains field entirely for the frontend service.
      The docker-compose.yml already has correct Traefik labels (Host(`hubllm.dev`), HTTPS
      entrypoint, letsencrypt certresolver, port 5173). With the Domains field empty, Coolify
      stops generating its broken auto-labels and the compose file labels work correctly.

      Also added HTTP→HTTPS redirect labels to docker-compose.yml so redirects are handled
      in version-controlled code rather than Coolify UI.

      CRITICAL: Never re-add domains to Coolify UI for this service — all Traefik routing
      is managed in docker-compose.yml. If Coolify fixes this bug in a future version,
      this policy can be revisited.
    note: |
      Verified: curl https://hubllm.dev/ returns 200. Container labels show only clean
      docker-compose.yml labels (no Host(''), no Caddy labels). Traefik proxy logs clean
      after redeploy — no more 'empty args for matcher Host' errors.

  - id: 18
    desc: "setupComplete check uses !== false — undefined/null bypasses setup wizard"
    sessions: [90, 91]
    affected_files: [frontend/src/App.jsx]
    status: fixed
    note: "Fixed in BUG-31: Changed to user.setup_completed === true. Only explicit true skips wizard. BUG-36/37 (Session 99): Merged skip+dismiss into single 'Skip setup' button that always persists to DB. Catch block no longer calls onComplete() on failure — shows inline error instead."

  - id: 19
    desc: "Project switch reconnected ALL terminal tabs — killed running SSH sessions"
    sessions: []
    affected_files: [MultiTerminal.jsx]
    status: fixed
    fix: "BUG-73: Each terminal object now owns its serverId/projectId. Project switch creates a new tab instead of reconnecting existing ones. Removed reconnect-on-prop-change useEffect from TerminalInstance. TerminalInstance receives per-terminal IDs with fallback to parent props."
